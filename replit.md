# Bahr El Ghazal Clinic Management System

## Overview
This full-stack web application is designed for the Bahr El Ghazal Clinic in rural South Sudan, offering comprehensive patient management, treatment tracking, laboratory testing, and X-ray/ultrasound examination capabilities. Its primary purpose is to provide a reliable healthcare management system that functions effectively both online and offline, catering to remote facilities with intermittent internet access. The project aims to improve healthcare delivery in underserved regions by digitizing essential clinic operations, enhancing data accuracy, and facilitating better patient care.

## User Preferences
Preferred communication style: Simple, everyday language.
User Context: Rural clinic in South Sudan requiring offline-capable system.

## System Architecture

### UI/UX Decisions
The frontend utilizes React with TypeScript, styled using Radix UI and shadcn/ui with Tailwind CSS, featuring a custom medical theme. Routing is handled by Wouter, and state management by TanStack Query.

### Technical Implementations
The backend is built with Node.js and Express.js, using TypeScript for a RESTful API with JSON responses. Data validation is performed using Zod schemas. The system supports offline functionality through local storage caching and a pending sync queue.

### Feature Specifications
- **Authentication & Security**: Username/password authentication with Passport.js local strategy, secure password hashing (scrypt), session-based authentication with httpOnly cookies, role-based access control (admin, reception, doctor, lab, radiology, pharmacy), and protected routes ensuring only authenticated users can access the system.
- **Patient Management**: Registration, search, unique ID generation, medical history, allergy tracking, and comprehensive admin-only patient deletion with audit logging. The deletion system includes soft-delete implementation with automatic validation that blocks deletion if patients have payment history or open encounters. Administrators can force-delete patients with financial history through an additional confirmation step. All deletions are logged in the audit trail with detailed impact summaries showing affected records (encounters, lab tests, X-rays, ultrasounds, pharmacy orders). Deleted patients are hidden from all operational views but preserved in the database for compliance and audit purposes. **Date Range Filtering (2025-11-04)**: World-class date filtering prevents overwhelming lists as patient database grows (40+ patients/day = 14,600+ annually). Smart filter buttons: Today (default), Yesterday, Last 7 Days, Last 30 Days, Custom Range. Custom Range features beautiful shadcn Calendar DatePickers and defaults to today's data when no dates selected. Helpful empty state messages guide users to select dates ("ðŸ“… Select start and end dates above"). Independent Search toggle allows name/ID lookups.
- **Treatment Module**: Visit recording, vital signs, chief complaint, diagnosis, treatment plans, and follow-up scheduling. Features a modern tabbed interface with Visit Notes (SOAP documentation), Lab Tests (ordering), Imaging (X-ray/ultrasound ordering), and Medications (pharmacy ordering). The medication ordering tab allows doctors to select drugs from inventory, specify dosage/quantity/instructions, and submit orders directly to the pharmacy dispensing queue, eliminating previous workflow confusion. **UI Simplification (2025-11)**: Patient History tab now shows ONLY past visits (filtered to exclude current encounter) to eliminate confusion and duplication. Clear labeling distinguishes "Previous Visits" from the current working visit, making the interface simpler and more intuitive for rural clinic staff. **Discharge Summary (2025-11)**: Comprehensive patient-friendly discharge documentation that consolidates all visit information into a single printable document. The discharge summary includes patient identification, visit details, diagnosis in plain language, treatment provided, medications with clear dosing instructions, test results summary (lab/X-ray/ultrasound findings), follow-up appointment details, warning signs for when to return immediately, and emergency contact information. Designed specifically for rural South Sudan context with simple language suitable for patients with limited literacy. Doctors can print and give this document to patients when treatment is complete, eliminating the confusion of multiple technical reports.
- **Payment System**: Integrated payment tracking across all diagnostic services (Laboratory, X-Ray, Ultrasound, Pharmacy) with support for partial payments on lab tests. The Payment page automatically displays all patients with pending payments on load, organized in a tabbed interface by department (Laboratory, X-Ray, Ultrasound, Pharmacy). Each pending payment shows patient name, patient ID, service description, and date. Clicking a pending payment card selects that patient, allowing staff to manually build the payment with the correct services and pricing. **Partial Payment Support (2025-11)**: Multi-test lab orders are automatically split into individual selectable items (e.g., a 3-test order shows as three separate line items with individual prices). Patients can pay for any combination of tests across multiple visits (e.g., pay for test 1 today, tests 2-3 tomorrow). The lab order is only marked "paid" when ALL tests are paid, supporting the clinic's flexible payment model for patients who may not have full payment upfront. Payment history now displays service breakdown badges (e.g., "Lab Tests (3)", "Consultation") for quick identification. Unpaid services display visual indicators (red background, UNPAID badge) and are blocked from results entry until payment is processed at reception. Payment status is automatically updated when payments are recorded through the payment module. The search functionality remains available for quick patient lookup. **Recent UX Improvements (2025-01)**: Fully mobile-optimized payment modal with three-column layout (stacks vertically on mobile): (1) Unpaid Orders section with "Add All Unpaid Items" quick action and color-coded status (red=unpaid, green=added), (2) Selected Items to Pay section showing payment list with individual item removal and sticky total display, (3) Payment Details section with summary card, receipt preview, payment method selection, and "Received By" field. Features collapsible service category selection with search filter, duplicate prevention, confirmation dialog before final submission, and large touch-friendly buttons. Uses simple language ("Selected Items to Pay" instead of "cart") suitable for non-technical rural clinic staff.
- **Laboratory System**: Comprehensive test ordering (blood, urine, stool, microbiology, chemistry, hormonal, STI/reproductive health, parasitic/tropical, tuberculosis), chemistry and hormonal machine integration, priority management, results recording with normal values, status tracking, photo upload for lab results, and payment validation. The system is designed to match clinic workflow, allowing doctors to order simple tests and technicians to input detailed results. It includes robust clinical interpretation, detecting critical medical findings and generating professional medical reports. **Display Improvements (2025-11)**: Lab test cards now show professional, specific titles with test count and preview (e.g., "10 Lab Tests (Blood Film, CBC, Hemoglobin...)" instead of generic "Parasitology"), providing clear, at-a-glance information about what tests were actually ordered. **Date Range Filtering (2025-11-04)**: Identical smart filtering system as Patient page prevents overwhelming test lists. Default to TODAY view, with Yesterday, Last 7/30 Days, and Custom Range options using elegant DatePicker components. Patient search allows finding specific historical tests. Helpful empty states guide technicians.
- **X-Ray Module**: Examination requests, safety checklists, findings, impression documentation, photo upload capability, offline sync functionality, modern Pending/Completed tab interface, and integrated payment validation requiring payment before exam performance. **Date Range Filtering (2025-11-04)**: Smart date filtering prevents overwhelming exam lists with same filter options as Laboratory (Today default, Yesterday, Last 7/30 Days, Custom Range with DatePicker). Patient search enables finding specific historical exams. **Layout Optimization (2025-11-04)**: Removed wasteful header and statistics cards section to match Laboratory's compact 2-column design. The page now starts immediately with the Pending/Completed exam lists, maximizing screen real estate for actual clinical work.
- **Ultrasound Module (ECube 8)**: Advanced ultrasound capabilities (cardiac echo, vascular Doppler, obstetric), specialized examinations, high-resolution imaging, quality assessment, comprehensive reporting with professional template systems for findings and impressions, photo upload capability, offline sync functionality, modern Pending/Completed tab interface, and integrated payment validation. **Date Range Filtering (2025-11-04)**: Smart date filtering identical to Laboratory and X-Ray modules with Today default, historical range options, Custom Range DatePickers, and patient search functionality. **Layout Optimization (2025-11-04)**: Removed bulky header and statistics cards to match Laboratory's efficient design. Direct 2-column layout prioritizes workflow over decorative elements.
- **Pharmacy Module**: Comprehensive inventory management with drug catalog, batch tracking (FEFO), inventory ledger, dispensing workflow, and stock management. Features include: auto-generated drug codes (DRG00001, DRG00002...), bulk purchase support (cartons/boxes with automatic quantity calculation), optional lot numbers, batch-specific pricing, FEFO batch dispensing to minimize waste, low stock and expiring drugs alerts, and supplier tracking.
- **Service Management (Admin)**: Centralized pricing management for all clinic services across departments (Laboratory, X-Ray/Radiology, Ultrasound, Consultation, Pharmacy, Procedures). Admin users can add new services, edit existing prices, deactivate discontinued services, assign service codes, and categorize services by department. The system supports price adjustments to accommodate market fluctuations. Pre-seeded with common laboratory tests, X-ray examinations, ultrasound scans, and consultation types. Services integrate with the payment system to ensure accurate billing.
- **Dashboard & Reporting**: Statistical overview, recent patient activity, common diagnosis analysis, printable reports, and mobile-optimized interface with touch-friendly interactions and responsive layouts. **Workflow Handoff (2025-11)**: Reception-focused dashboard features three critical widgets: (1) Patient Flow & Queue Monitor showing real-time patient distribution across 7 workflow stages (Waiting for Doctor, In Treatment, Waiting for Lab/X-ray/Ultrasound, Waiting for Pharmacy, Ready for Checkout), (2) Outstanding Payments displaying unpaid services with SSP amounts and clickable links to payment processing, and (3) Results Ready to Review widget showing completed lab/X-ray/ultrasound results awaiting doctor review. The Results Ready widget solves a critical workflow gap by alerting reception staff when diagnostic results are complete so patients can be routed back to doctors for review and treatment continuation. **Results Ready Widget Enhancements (2025-11-04)**: Smart patient-encounter grouping displays one entry per patient visit regardless of how many tests were ordered (e.g., patient with lab+xray+ultrasound shows as single grouped entry with result count badge). Today-only filtering shows only current day results for fresh morning workflow start. Active encounter filtering excludes completed/discharged patients to prevent clutter. Dynamic icon colors match department themes (Lab=orange TestTube, X-ray=purple Scan, Ultrasound=blue MonitorSpeaker). Click-to-navigate cards link directly to treatment page with patient pre-selected. Result summaries show test count, multiple result type badges, and truncated test list preview. Critical bug fix: corrected encounter ID lookup to use string `encounterId` instead of numeric `id` for proper filtering. Revenue/financial data removed from reception dashboard to maintain privacy and appropriate access control.
- **Age-centric Design**: "Date of Birth" has been replaced with "Age" throughout the system to align with local user contexts.

### System Design Choices
The application is designed for both cloud and local network deployments. A key architectural decision is the robust offline-first approach, enabling full functionality without continuous internet access. The database layer uses Drizzle ORM with PostgreSQL (Neon) for cloud deployment and SQLite for local/offline environments. Automated migration scripts ensure data consistency.

## External Dependencies

- **Frontend**: React, TypeScript, Radix UI, shadcn/ui, Tailwind CSS, Wouter, TanStack Query, Lucide React, React Hook Form, Zod.
- **Backend**: Node.js, Express.js, TypeScript, Zod.
- **Database & ORM**: Drizzle ORM, Neon Database (PostgreSQL), Better SQLite3.
- **Development Tools**: Vite, ESBuild, Replit.